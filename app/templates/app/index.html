<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Editor with Run Code</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #chat-log-editor {
            width: 100%;
            height: 300px;
            font-size: 20px;
        }

        #output-box {
            width: 95%;
            height: 200px;
            font-size: 25px;
            resize: none;
            margin-top: 10px;
            margin-right: 10px;
        }

        #input-box {
            width: 95%;
            height: 200px;
            font-size: 25px;
            resize: none;
            margin-top: 10px;
            margin-right: 10px;
        }

        /* Loader animation */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            margin-left: 10px;
            display: none;
            /* Initially hidden */
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #run-button {
            width: max-content;
            height: max-content;
            background-color: palegreen;
            border: 2px solid gray;
            border-radius: 5px;
            margin: 20px;
        }


        .heading-text {
            font-family: Oswald;
            font-size: 2.25em;
            font-weight: bold;
            color: black;
            text-align: center;
            background-color: #a6efff;
            background-image: linear-gradient(19deg, #79e6ff 0%, #e8b6ff 100%);
        }

        .heading {
            margin-top: 30px;
        }

        .input-output {
            display: flex;
            margin: auto;

        }
    </style>
</head>

<body>

    <div class="heading">
        <p class="heading-text"> Room Name : {{ groupname }} </p>
    </div>

    <div class="js-data">
        {{ groupname|json_script:"group_name" }}
    </div>

    <form>
        {% csrf_token %}
        <textarea id="chat-log-editor">{{ group.containt }}</textarea>
    </form>
    <!-- Code Editor-like Textarea using CodeMirror -->

    <!-- Run Code Button -->
    <button id="run-button">Run Code</button>
    <span class="loader" id="loader"></span>

    <div class="input-output">

        <div class="input">
            <label for="input-box">Enter Your Input</label>
            <textarea id="input-box"></textarea>
        </div>

        <div class="output">
            <label for="output-box">Output</label>
            <textarea id="output-box" readonly></textarea>
        </div>

    </div>

    <div id="hackerrank-output-box"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.0/mode/python/python.min.js"></script>
    <script>
        const group_name = JSON.parse(document.getElementById('group_name').textContent);
        console.log(group_name);
        var ws = new WebSocket('ws://127.0.0.1:8000/ws/ac/' + group_name + '/');

        ws.addEventListener('open', () => {
            console.log('websocket connection open....');
        });

        ws.addEventListener('error', (event) => {
            console.log('websocket connection error occurred....', event);
        });

        ws.addEventListener('close', (event) => {
            console.log('websocket connection close....', event);
        });

        const chatLogEditor = document.getElementById('chat-log-editor');

        // Initialize CodeMirror
        const editor = CodeMirror.fromTextArea(chatLogEditor, {
            mode: "python",
            lineNumbers: true,
            theme: "default"
        });

        // Set a flag to prevent infinite loop
        let updatingFromWebSocket = false;

        // Attach input event to CodeMirror instance
        editor.on("change", () => {
            if (!updatingFromWebSocket) {
                var message = editor.getValue();
                console.log("Sending message:", message);
                ws.send(JSON.stringify({
                    'msg': message
                }));
            }
        });

        // Run Code Button
        const runButton = document.getElementById('run-button');
        runButton.addEventListener('click', async () => {
            try {
                const code = editor.getValue();
                const inputvalue = document.getElementById('input-box').value;
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                const loader = document.getElementById('loader');
                const outputBox = document.getElementById('output-box');

                // Show loader and hide output
                loader.style.display = 'inline-block';
                outputBox.textContent = '';
                outputBox.style.display = 'none';

                const response = await fetch('http://127.0.0.1:8000/result/output/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ code: code, inputvalue: inputvalue })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log(data);
                    outputBox.textContent = data.output;
                    outputBox.style.display = 'block';
                } else {
                    console.log('Error:', response.statusText);
                }

                // Hide loader
                loader.style.display = 'none';
            } catch (error) {
                console.log('Error:', error);
                // Hide loader on error as well
                loader.style.display = 'none';
            }
        });

        ws.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);
            updatingFromWebSocket = true;
            const cursor = editor.getCursor(); // Get current cursor position
            editor.setValue(data.msg); // Update the content as-is
            editor.setCursor(cursor.line, cursor.ch); // Set cursor back to the previous position
            editor.clearHistory();
            updatingFromWebSocket = false;
        });
    </script>

</body>

</html>